<!DOCTYPE html>
<html>
<head>
<title>Draw50</title>
<meta name="Draw50" content="A simple drawing web app">
<link rel="shortcut icon" src="favicon.ico"/>
<!-- Load the Paper.js library -->
<link rel="stylesheet" src="css/main.css">
<script type="text/javascript" src="js/paper.js"></script>
<script type="text/javascript" src="js/hammer.min.js"></script>
<!-- Define inlined PaperScript associate it with myCanvas -->
<script type="text/paperscript" canvas="draw50Canvas">

  var path;
  var pathCreated = false;
  var onErase = false;
  var canDraw = true;
  var activeCanvas = document.getElementById('draw50Canvas');
  var undoArray = [];
  var drawDot = false;
  var didClearCanvas = false;

  // create a simple instance
  // by default, it only adds horizontal recognizers
  var mc = new Hammer.Manager(activeCanvas, {
    recognizers: [
      // RecognizerClass, [options], [recognizeWith, ...], [requireFailure, ...]
      [Hammer.Rotate, { enable: true, pointers: 0}],
      [Hammer.Pan, { pointers: 1 }],
      [Hammer.Tap],
      [Hammer.Pinch, { pointers: 0 }]
    ]
  });

  // specifically deal with drawing dot scenarior, because we no longer trigger
  // drawing using "onMouseDown"
  mc.on('tap', function(ev) {
    canDraw = true;
    var dot = new Path.Circle(new Point(ev.center.x,ev.center.y), 10);
    dot.fillColor = 'white';
    project.activeLayer.addChild(dot);
  });

  // allow drawing if it is a 1-finger interaction
  mc.on('panmove', function(ev) {
    canDraw = true;
  });

  // using "rotate" recognizer to detect multi-fingers situation
  mc.on("rotate", function(ev) {

    // 2 fingers for erasing
    if (ev.maxPointers === 2) {
      canDraw = true;
      onErase = true;
    };

    // suspending 3-finger action
    if (ev.maxPointers === 3) {
      canDraw = false;
      onErase = false;
    };

    // suspending 4-finger action
    if (ev.maxPointers === 4) {
      canDraw = false;
      onErase = false;
    };

    // 5 fingers for panning
    if (ev.maxPointers === 5) {
      canDraw = false;
      onErase = false;
      window.scrollBy(-ev.deltaX/20, -ev.deltaY/20);
    };

    // suspending 6-finger action
    if (ev.maxPointers === 6) {
      canDraw = false;
      onErase = false;
    };

    // 7+ fingers to clear canvas
    if (ev.maxPointers > 7 && Math.abs(ev.deltaTime) > 150) {
      project.activeLayer.removeChildren();
      canDraw = true;
      didClearCanvas = true;
      pathCreated = false;
    };

  });

  function onMouseDown(event) {};

  // drawing on canvas
  function onMouseDrag(event) {

    // prevent drawing for certain action
    if (!canDraw) {
      return;
    };

    didClearCanvas = false;

    // create path for the very first draw
    if (!pathCreated) {
      path = new Path();
      pathCreated = true;
    };

    // when erasing, switch stroke color to black can start drawing
    // notice that we don't smooth path, because it is unnecessary
    if (onErase) {
      console.log("drawing black")
      path.strokeColor = 'black';
      path.strokeWidth = 50;
      path.add(event.point);
      return;
    };

    // regular drawing
    path.strokeColor = 'white';
    path.strokeWidth = 10;
    path.add(event.point);
    path.smooth();

  };

  function onMouseUp(event) {

    // clean up path if it is not erasing
    if (!onErase) {
      path.smooth();
      path.simplify(30);
    }
    onErase = false;
    // create a new path for the next drawing
    path = new Path();
  };

  function undoPath() {
    var arrayLength = project.activeLayer._children.length;
    undoArray.push(project.activeLayer._children[arrayLength-2]);
    project.activeLayer._children[arrayLength-2].remove();
  }

  function redoPath() {
    project.activeLayer.addChild(undoArray[undoArray.length - 1]);
    undoArray.pop();
  }

  try {
    document.getElementById('undo').onclick = function() {
      undoPath();
    };

    document.getElementById('redo').onclick = function() {
      redoPath();
    };
  } catch (error) {};

</script>

</head>
<body>
  <button id="undo">Tap this to Undo </button>
  <button id="redo">Tap this to Redo </button>
  <canvas id="draw50Canvas" width=1920 height=1080 style="background-color: black"></canvas>
</body>
</html>
